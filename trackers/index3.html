<html>
<head>
  <!DOCTYPE html>
  <meta charset="utf-8">

  <style type="text/css">
    /*css to go here*/

    body {
      background-color:#f3f2f7;
      font-family: fanwood, serif;
      font-size:17px;
      font-style: text;
      text-align: center;
      letter-spacing: 0.5px;
      margin:0px;

  }


  svg {
  /*  border: 1px solid #f0f;
  */  /*color: white;*/
      /*fill: white;*/
      z-index: 2;
      display:inline;
  }


  .axis line,
  .axis path {
    fill:none;
    stroke:silver;
    stroke-width:1;
  }


  .axis text {
    fill: black;
    font-family: europa, sans-serif;
    font-style: light;
    text-transform: uppercase;
    font-size: 10px;
    letter-spacing: 1px;
}

  .tick line {
    fill: none;
    stroke-dasharray: 2px 4px;
  }

  .y-axis-label {
    margin-left:0px;
  }



  .time-title {
    display:inline;
  }

  .wrapper {
    height: 100%;
    display:inline;
    margin:20px;
  }


  .tooltip {
    width: 200px;
    font-family: europa, sans-serif;
    font-style: light;
    font-size: 12px;
    background:rgba(255,255,255,0.65);
    padding:5px;
    line-height:1.25;
    clear:both;
    text-align: center;
  }



  .n::after {
    font-size:18px;
    width: 200px;
    color: black;
    content: "\2193";
    position:absolute;
    text-align:center;
    display:block;
    pointer-events:none;
    margin-top:5px;
  }

  .s::before {
    font-size:18px;
    width: 200px;
    color: black;
    content: "\2191";
    position:absolute;
    text-align:center;
    display:block;
    pointer-events:none;
    clear:both;
    margin-top:-27px;
  }

  .hover-line {
  fill: none;
  stroke-dasharray: 2px 4px;
  stroke:magenta;
  stroke-width:1;
  }

.hoverLabels{
  fill: black;
  font-family: europa, sans-serif;
  font-style: light;
  font-size: 12px;
}

  .container {
    overflow: auto;
    margin-top: 70px;
    margin-bottom: 150px;
    display:block;
    width:100%;
  }



  #intro-container {
    height:100%;
    width:100%;
    /*display:block;*/
    overflow: auto;
    /*background-color: silver;*/
    color: white;
    margin-bottom: 170px;
    padding: 105px 0 0 0;
  }

  .hero-imgs {
    overflow: auto;
    position:absolute;
    left:0px;
    top:0px;
    width:100%;
    z-index:-10;
    opacity:0.15;
  }

  .hero-imgs img {
    opacity:0.7;
    min-width:100%;
    min-height: 100%;

  }

  #intro-text {
    width:60%;
    margin:auto;
  -webkit-columns: 2;
     -moz-columns: 2;
          columns: 2;
  -moz-column-fill: balance;
       column-fill: balance;    
  -webkit-column-gap: 30px;
     -moz-column-gap: 30px;
          column-gap: 30px;    
    text-align: left;
    line-height: 22px;
    margin-bottom:7%;
  }

  #hed h1 {
    margin-bottom: 30px;
    margin-top: 0px;
  }

  #hed p {
    margin-bottom: 5px;
  }

  h1 {
    font-size:58px;
    font-family: fanwood, serif;
    font-style: regular;
    font-weight: 400;
    margin-bottom: 25px;
    margin-top:25px;
  }
  h2 {
    font-family: europa, sans-serif;
    font-size:28px;
    letter-spacing: 1px;
    font-weight:900;
    /*border-bottom: 1px solid;*/
  }

  h4 {
    font-family: europa, sans-serif;
    font-style: light;
    font-size:12px;
    letter-spacing: 8px;
    text-transform: uppercase;
    margin-bottom: -30px;
    font-weight:400;
    /*border-bottom: 1px solid;*/
  }

  h5 {
    font-family: europa, sans-serif;
    font-style: light;
    font-weight:400;
    font-size:10px;
    letter-spacing: 2px;
    text-transform: uppercase;
  }


  #context-container {
    width:100%;
    position: fixed;
    bottom:0%;
    padding-bottom:20px;
    padding-top: 20px;
    background-color: white;
    margin-bottom:0;
    margin-left:0;
  }

  #context{
    margin:auto;
    display:block;
  }

  .description{
    display:flex;
    align-items:center;
    margin: 0% 20%;
  }

  .description-body {
    display:inline-block;
    text-align: left;
    border-left: 1px solid;
    border-right: 1px solid;
    padding: 0px 60px;
    margin: 0px 60px;
    font-size:15px;
  }

  .description-hed {
    display:inline-flex;
    align-items:center;
    text-align:left;
    width:60%;
  }
  .description-key{
    font-family: europa, sans-serif;
    font-size:10px;
    text-transform: uppercase;
    text-align:left;
    width:45%;
  }
  .description-key p {
    line-height: 22px;
}

  .description p {
    margin:0;
    padding:0;
  }

  .description a {
    color:black;
  }


  #affectiva-container .description{
    margin-top: 75px;
  }
  #context-description {
    width:360px;
    padding-right: 0px;
    margin-top: 0px;
    padding-top: 30px;
    padding-bottom: 20px;
    margin-left: -20px;
    font-family: europa, sans-serif;
    font-size:15px;
    letter-spacing: 1px;
    /*text-transform: uppercase;*/
    font-weight:600;
  }

  .arrow {
    display:block;
    width: 1px;
    height:100px;
    background-color:white;
    margin: auto;
  }
  .arrow::after {
    content: "\25BE";
    display:block;
    position:relative;
    top:100px;
    text-align: center;
    margin-left:-4px;
    line-height:2px;

  }

  .alt-axis {
    font-family: europa, sans-serif;
    font-weight:600;
    font-size:12px;
    letter-spacing: 2px;
    text-transform: uppercase;
  }

  .compulsion-x {
    font-family: europa, sans-serif;
    font-weight:800;
    font-size:12px;
    text-align: left;
  }

  #intro-text a {
    color:white;
  }

.selection {
  fill: orangered;
  stroke-width:1.5;
  stroke:orangered;
}

.viewport-nav {
  font-size:11px;
  display:inline-block;
  font-weight: bold;
  position:absolute;
  font-family: europa, sans-serif;
  text-transform: uppercase;
}

#viewport-back {
  left:55px;
  top:50px;
}
#viewport-forward {
  right:55px;
  top:50px;

}
  </style>


</head>
<body>
  <script src="https://d3js.org/d3.v4.min.js"></script>
  <script src="https://d3js.org/d3-time.v1.min.js"></script>
  <script src="_viz/_dashboard/d3-tip.js"></script>
  <script src="_viz/_dashboard/jquery-3.3.1.js"></script>

  <link rel="stylesheet" href="https://use.typekit.net/fao6qlb.css">

  <div id="intro-container">
    <div id="hed">
    <p>üòêüòêüòêüòêüò±</p>
    <h1>Speak, (Random Access) Memory</h1>
  </div>
  <div id = "intro-text">
     As a professional graphic designer, a grad student in a technology program, and a single person who lives alone in NYC, I probably get more facetime with my computer than with all of humanity combined. So during the fall of 2018, when I began work on a system of trackers for a host of potential/evidenced metrics of depression, it was clear that my laptop would be my best data collector.
    <p>Speak, (Random Access) Memory is a project that hopes to monitor depression's cyclical nature, identify correlations between mood and my activity/environment, predict the onset of depression by feeding this data into a machine-learned model/neural network, and ultimately preempt it by teaching the system to recommend and enforce interventions. As a preliminary exercise, I've trained a couple ML models to predict mood with only a month of data; <a href="http://www.xujenna.com/itp_blog/2018/05/02/final-pt-2-data-analysis/" target="new">see the documentation here</a>.</p><p>Presently, there are seven trackers collecting data on 45 metrics; below are visualizations of the data collected by my <a href="http://www.xujenna.com/itp_blog/2018/04/26/final/" target="new">homemade python trackers</a>. The last chart visualizes correlations among 40 select metrics. Use the brush at the bottom of the window to navigate through my entire archive of data.</p>
  </div>
  <h5>To begin, filter the data by date:</h5><span class="arrow"></span></p>
  </div>
  </div>
  <div class="container" id="context-container">
    <div class="viewport-nav" id="viewport-back">&ltrif; prev</div>
    <svg id="context"></svg>
    <div class="viewport-nav" id="viewport-forward">next &rtrif;</div>

  </div>

  <div class="container" id="reporter-container">
    <div class="description">
      <div class="description-hed"><h2>Mood Reporter</h2></div>
      <div class="description-body">
        Because affect is difficult to measure, psychiatry traditionally employs self-administered questionnaires as diagnostic tools for mood disorders; these usually attempt to quantify the severity of DSM-IV criteria. The module for depression is called the PHQ-9, and I've adapted several of its questions into my own questionnaire, which python deploys every hour via the command line. All variables are rated on a scale of 1-5.
      </div>
      <div class="description-key">
        <p><span style="color:rgb(255, 0, 255)">&block; &nbsp;</span> Mood</p>
        <p><span style="color:rgb(245, 205, 0)">&block; &nbsp;</span> Morale</p>
        <p><span style="color:rgb(0, 0, 255)">&block; &nbsp;</span> Stress</p>
        <p><span style="color:rgb(200, 200, 220)">&block; &nbsp;</span> Fatigue</p>
        <p><span style="color:rgb(0, 0, 255); font-size:18px; line-height: 14px"><b>&times;&nbsp;</b></span> Compulsions</p>
      </div>

    </div>
    <svg id="reporter"></svg>
  </div>

  <div class="container" id="affectiva-container">
    <div class="description"><h2>Facial Analysis</h2>
      This tracker utilizes the Affectiva API, an emotion and facial recognition model. Via my laptop's webcam, it analyses my face for a minute every hour; a python script grabs the min and max <span style="color:rgb(255, 0, 255)"><b>attention</b></span> and <span style="color:rgb(0, 225, 225)"><b>valence</b></span> values, as well as the expressions made (plotted with emoji) and the amount of times I <span style="color:rgb(0, 0, 255)"><b>blinked</b></span> (calculated by dividing the number of times the eyeClosure variable hit 99.9%, divided by 2).<p>I choose these variables as <a href="http://www.xujenna.com/itp_blog/2018/02/01/blinking-mind-wandering/" target="new">an attempt to measure mindwandering</a>, a marker strongly correlated with depression. The emojis were included to illustrate the concept of valence (also just for funsies).</p>
    </div>
    <svg id="affectiva"></svg>
  </div>

  <div class="container" id="keylogger-container">
    <div class="description"><h2>Keylogger Sentiments</h2>
      The idea for this is simply to discern the sentiment of everything I type. I wrote a keylogger in python, which collects any coherent phrase to be sent to IBM Watson's Tone Analyzer every hour. The API provides several sentiment categories: <span style="color:rgb(255, 0, 255)"><b>joy</b></span>, <span style="color:rgb( 0, 255, 127)"><b>confidence</b></span>, <span style="color:rgb(245, 205, 0)"><b>analysis</b></span>, <span style="color:rgb(200, 200, 220)"><b>tentativeness</b></span>, <span style="color:rgb(0, 225, 225)"><b>sadness</b></span>, <span style="color:rgb(0, 0, 225)"><b>fear</b></span>, and <span style="color:rgb(255, 105, 180)"><b>anger</b></span>.
    </div>
    <svg id="keylogger"></svg>
  </div>

  <div class="container" id="tabCounter-container">
    <div class="description"><h2>Browser Activity</h2>
    This tracker is a Chrome Extension, and counts the number of tabs as they're <span style="color:rgb( 0, 255, 127)"><b>created</b></span> and <span style="color:rgb(245, 205, 0)"><b>activated</b></span>, as well as the final, hourly count of <span style="color:rgb(255, 0, 255)"><b>tabs</b></span> and <span style="color:rgb(0, 0, 225)"><b>windows</b></span> left open. I wanted to track my browser activity because I've noticed a relationship between all of these variables and my motivation and stress levels. I'm a tab hoarder in general, but if I'm feeling either especially overwhelmed or lethargic, I'm even more likely to open tabs but not actually consume their content, thus leaving them open indefinitely. The number of tabs in the browser graveyard then contributes to this underlying stress/anxiety, effectively creating a positive feedback loop of mounting existential dread.
    </div>
    <svg id="tabCounter"></svg>
  </div> 

<script>

// var dir = "file:///Users/jxu2/github/thesis_explorations/trackers/affectiva/photos/";
var dir = "affectiva/photos/";
var fileextension = ".jpg";
$.ajax({
    //This will retrieve the contents of the folder if the folder is configured as 'browsable'
    url: dir,
    success: function (data) {
        //List all .png file names in the page
        var fileList = $(data).find("a:contains(" + fileextension + ")").slice(-13);
        // console.log(fileList)
        fileList.each(function () {
            var filename = this.href.replace(window.location.host, "").replace("http://", "");
            $("#intro-container").append("<div class='hero-imgs'><img src='" + dir + filename + "'></div>");
        });
    }
});

</script>

<script>

var margin = {top: 50, right: 40, bottom: 50, left: 40};
var margin2 = {top: 5, right:2, bottom:20, left:2};

var width = (window.innerWidth - 460) - margin.right - margin.left,
height = 550 - margin.top - margin.bottom;

var height2 = 80 - margin2.top - margin2.bottom;
var width2 = (window.innerWidth - 300) - margin2.right - margin2.left;
var body = d3.select("body");

var contextSVG = d3.select("#context")
      .attr("width", width2 + margin2.left + margin2.right)
      .attr("height", height2 + margin2.top + margin2.bottom);


var reporterSVG = d3.select("#reporter")
      .attr("width", width + margin.left + margin.right)
      .attr("height", height + margin.top + margin.bottom);


var xScale = d3.scaleTime()
  .range([0,width]);
  // .domain([xMin, xMax]);

var xScale2 = d3.scaleTime()
.range([0,width2]);

var yScale = d3.scaleLinear()
  .range([height,0]);
  // .domain([0.45,1]);

var yScale2 = d3.scaleLinear()
  .range([height2,0]);

var xAxis = d3.axisBottom(xScale).tickPadding(10);
var xAxis2 = d3.axisBottom(xScale2).tickSize(-height2).tickPadding(10);
var yAxis = d3.axisLeft(yScale).tickSize(-width).ticks(5).tickPadding(10).tickSizeOuter(0);


var reporterChart = reporterSVG.append("g")
  .attr("class", "focus")
  .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

var contextChart = contextSVG.append("g")
  .attr("class", "context")
  .attr("transform", "translate(" + margin2.left + "," + margin2.top + ")");



  var brush = d3.brushX()
    .extent([[0,0], [width2, height2]])
    .on("brush end", brushed);


  var moodArea = d3.area()
      // .curve(d3.curveCardinal)
      .x(function(d) { return xScale(d.time); })
      .y1(function(d) { return yScale(d.mood); })
      .y0(height)
        .defined(function(d){return d.mood!=null;});

  var fatigueArea = d3.area()
    // .curve(d3.curveCardinal)
    .x(function(d) { return xScale(d.time); })
    .y1(function(d) { return yScale(d.fatigue); })
    .y0(height)
      .defined(function(d){return d.fatigue!=null;});


  var stressArea = d3.area()
      // .curve(d3.curveCardinal)
      .x(function(d) { return xScale(d.time); })
      .y1(function(d) { return yScale(d.stress); })
      .y0(height)
        .defined(function(d){return d.stress!=null;});

  var moraleArea = d3.area()
      // .curve(d3.curveCardinal)
      .x(function(d) { return xScale(d.time); })
      .y1(function(d) { return yScale(d.morale); })
      .y0(height)
        .defined(function(d){return d.morale!=null;});


  var moodLine = d3.line()
  .defined(function(d){return d.mood!=null})
    .x(function(d) {return xScale(d.time);})
    .y(function(d){return yScale(d.mood) - 1.5;});

  var moodLine2 = d3.line()
  .defined(function(d){return d.mood!=null})
    .x(function(d) {return xScale2(d.time);})
    .y(function(d){return yScale2(d.mood);});

var newResponses = [];



d3.tsv("reporter/responses.tsv", function (err, responses) {
    if (err) console.warn(err, "error loading data");


responses.forEach(function(d){
  var dateTime = new Date(d.unix_time * 1e3);
  d.time = dateTime;
  d.mood = +d.mood;
  d.fatigue = +d.fatigue;
  d.morale = +d.morale;
  d.social = +d.social;
  d.stress = +d.stress;
});



responses.forEach(function(d,i){

newResponses.push(d)

  if(i+1 == responses.length){
    return;
  }


  var timee = responses[i+1].time;


  if(d.time < (timee - 24000000)) {
    var nullTime = new Date(timee - 24000000);
    var nullItems = {};

    nullItems["time"] = nullTime;
    nullItems["mood"] = null;
    nullItems["moodNotes"] = null;
    nullItems["fatigue"] = null;
    nullItems["stress"] = null;
    nullItems["activities"] = null;
    nullItems["morale"] = null;
    nullItems["compulsions"] = null;

    newResponses.push(nullItems);
  }

})


var xScaleMax = d3.max(newResponses, function(d) {return d.time;})
var xScaleMin = new Date(1524982083090)

xScale.domain([xScaleMin, xScaleMax]);
yScale.domain([0,5]);
yScale2.domain(yScale.domain());

var domainMax = new Date(parseInt(newResponses[newResponses.length-1].unix_time * 1000));
var domainMin = new Date();
domainMin.setMonth(domainMax.getMonth() - 1);

xScale2.domain([domainMin, domainMax])


reporterChart.append("g")
  .attr("class", "axis axis--x")
  .attr("transform","translate(0, "+(height)+")")
  .call(xAxis);

reporterChart.append("g")
.attr("class", "axis axis--y")
  .call(yAxis);



reporterChart.append("path")
  .datum(newResponses)
  .attr("class", "moodArea")
  .attr("d", moodArea)
  .attr("fill", "magenta")
  .attr("opacity", 0.4);

reporterChart.append("path")
  .datum(newResponses)
  .attr("class", "moraleArea")
  .attr("d", moraleArea)
  .attr("fill", "gold")
  .attr("opacity", 0.4);


reporterChart.append("path")
  .datum(newResponses)
  .attr("class", "stressArea")
  .attr("d", stressArea)
  .attr("fill", "blue")
  .attr("opacity", 0.25);


reporterChart.append("path")
  .datum(newResponses)
  .attr("class", "fatigueArea")
  .attr("d", fatigueArea)
  .attr("fill", "lavender")
  .attr("opacity", 0.7);



var compulsionCircles = reporterChart.selectAll(".compulsion-circle")
  .data(newResponses)
  .enter()
  .append("text")
  .attr("class","compulsion-x")
  .attr("x", function(d) {return xScale(d.time) - 1200})
  .text(function(d){ return d.compulsions == "False" || d.compulsions == null ? console.log("null") : "√ó"})
  .attr("y", function(d){return yScale(d.stress) + 3;})
  .attr("opacity", 0.7)
  .attr("fill", "blue");

reporterChart.append("path")
  .datum(newResponses)
  .attr("d", moodLine)
  .attr("stroke", "magenta")
  .attr("stroke-width", 2)
  .attr("fill", "none")
  .attr("class", "moodLine")
  .attr("opacity", 0.7);


var moodCircles = reporterChart.selectAll(".moodCircle")
  .data(newResponses)
  .enter()
  .append("circle")
  .attr("class","moodCircle")
  .attr("cx", function(d) {return xScale(d.time)})
  .attr("r", function(d) {return d.mood == null ? 0 : 3; })
  .attr("cy", function(d) { return yScale(d.mood);})
  .attr("opacity", 0.7)
  .attr("fill", "magenta");





// contextChart.append("path")
//   .attr("d", moodLine2(newResponses))
//   .attr("stroke", "black")
//   .attr("stroke-width", 2)
//   .attr("fill", "none")
//   .attr("class", "line");

var month = new Array();
month[0] = "January";
month[1] = "February";
month[2] = "March";
month[3] = "April";
month[4] = "May";
month[5] = "June";
month[6] = "July";
month[7] = "August";
month[8] = "September";
month[9] = "October";
month[10] = "November";
month[11] = "December";


var dataLength = newResponses.length
var maxDate = newResponses[dataLength-1]['time']
var maxDateDay = new Date()
maxDateDay.setDate(maxDate.getDate() - 1)


var contextNavBack = d3.select("#viewport-back");
var contextNavForward = d3.select("#viewport-forward");
var currentDisplayDate = new Date(parseInt(newResponses[newResponses.length-1].unix_time * 1000));
var currentDisplayIndex = currentDisplayDate.getMonth();


// var firstDate = new Date(1524982083090);

contextChart.append("g")
    .attr("class", "axis")
    .attr("transform", "translate(0," + height2 + ")")
    .call(xAxis2);

var currentID = "March";

contextChart.selectAll(".mood-bars")
  .data(newResponses)
  .enter().append("rect")
  .filter(function(d) {return d.unix_time > 1524981000})
  .attr("class", "mood-bars")
  .attr("id", function(d){
    var currentDate = new Date(parseInt(d.unix_time * 1000))
    var currentMonth = currentDate.getMonth()
    if (month[currentMonth] == currentID) {
      console.log("skip")
    }
    else {
      currentID = month[currentMonth];
      return currentID;
    }
  })
  .style("fill", "grey")
  .style("opacity", "0.3")
  .attr("x", function(d) {return xScale2(d.time)})
  .attr("width", "3px")
  .attr("y", function(d) {return yScale2(d.mood)})
  .attr("height", function(d) {return height2 - yScale2(d.mood)})


var contextBrush = contextChart.append("g")
    .attr("class", "brush")
    .call(brush)
    .call(brush.move, [maxDateDay, maxDate].map(xScale2));


var prevLink = document.getElementById(month[currentDisplayIndex-1])
var nextLink;


contextNavBack.text("‚óÇ " + month[currentDisplayIndex-1]).style("cursor", "pointer").on("mousedown", function(d){
  // prevLink.scrollIntoView();
  currentDisplayIndex--;

  prevLink = document.getElementById(month[currentDisplayIndex-1])
  nextLink = document.getElementById(month[currentDisplayIndex+1])

  if(prevLink !== null){
    contextNavBack.text("‚óÇ " + month[currentDisplayIndex-1]);
    contextNavForward.text(month[currentDisplayIndex+1] + " ‚ñ∏")
  }
  else{
    contextNavBack.text(" ");
    contextNavForward.text(month[currentDisplayIndex+1] + " ‚ñ∏")
  }

  domainMax = new Date(2018, currentDisplayIndex+1)
  domainMax.setDate(domainMax.getDate()-1)
  domainMin = new Date(2018, currentDisplayIndex)
  // domainMax = new Date(d3.select(nextLink).datum().unix_time * 1000)
  // domainMin = new Date(d3.select(nextLink).datum().unix_time * 1000)
  // domainMin.setMonth(domainMin.getMonth() - 1);  
  console.log("Max", domainMax)
  console.log("Min", domainMin)
  xScale2.domain([domainMin, domainMax])
  contextChart.selectAll(".axis").call(xAxis2)
  var brushMin = new Date(domainMax)
  brushMin.setDate(brushMin.getDate()-1)
  console.log("brushMin", brushMin)
  console.log("brushMax", domainMax)
  console.log("mapped", [brushMin, domainMax].map(xScale2))

  contextChart.selectAll("rect").attr("x", function(d) { return xScale2(d.time); })
  contextBrush.call(brush.move, [brushMin, domainMax].map(xScale2))

  contextChart.selectAll(".selection").call(contextTip)
  });

contextNavForward.text(" ").style("cursor", "pointer").on("mousedown", function(d){
  // nextLink.scrollIntoView();
  currentDisplayIndex++;

  prevLink = document.getElementById(month[currentDisplayIndex-1])
  nextLink = document.getElementById(month[currentDisplayIndex+1])

  if(nextLink !== null){
    contextNavBack.text("‚óÇ " + month[currentDisplayIndex-1]);
    contextNavForward.text(month[currentDisplayIndex+1] + " ‚ñ∏")
    // domainMax = new Date(d3.select(nextLink).datum().unix_time * 1000)
    // domainMin = new Date(d3.select(nextLink).datum().unix_time * 1000)
    // domainMin.setMonth(domainMin.getMonth() - 1);  

  }
  else{
    contextNavBack.text("‚óÇ " + month[currentDisplayIndex-1]);
    contextNavForward.text(" ")
    // domainMax = new Date(d3.select(prevLink).datum().unix_time * 1000)
    // domainMin = new Date(d3.select(prevLink).datum().unix_time * 1000)
    // domainMax.setMonth(domainMax.getMonth() + 2);  
    // domainMin.setMonth(domainMin.getMonth() + 1);  

  }

  domainMax = new Date(2018, currentDisplayIndex+1)
  domainMax.setDate(domainMax.getDate()-1)
  domainMin = new Date(2018, currentDisplayIndex)

  console.log("Max", domainMax)
  console.log("Min", domainMin)
  xScale2.domain([domainMin, domainMax])
  contextChart.selectAll(".axis").call(xAxis2)
  var brushMin = new Date(domainMax)
  brushMin.setDate(brushMin.getDate()-1)
  console.log("brushMin", brushMin)
  console.log("brushMax", domainMax)
  console.log("mapped", [brushMin, domainMax].map(xScale2))

  contextChart.selectAll("rect").attr("x", function(d) { return xScale2(d.time); })
  contextBrush.call(brush.move, [brushMin, domainMax].map(xScale2))

  contextChart.selectAll(".selection").call(contextTip)
});




// var handle = contextBrush.selectAll(".handle--custom")
//   .data([{type: "w"}, {type: "e"}])
//   .enter().append("path")
//     .attr("class", "handle--custom")
//     .attr("fill", "#666")
//     .attr("fill-opacity", 1)
//     .attr("stroke", "#000")
//     .attr("stroke-width", 1)
//     .attr("cursor", "ew-resize")
//     .attr("d", d3.arc()
//         .innerRadius(0)
//         .outerRadius(height2/2)
//         .startAngle(0)
//         .endAngle(function(d, i) { return i ? Math.PI : -Math.PI; }));


  var reporterTip = d3.tip()
    .attr("class", "tooltip")
    .offset([-20,-5])
    .html(function(d,i) {
    return "<b>" + d.moodNotes + "</b>: " + d.trigger;
    });

  reporterChart.selectAll(".moodCircle")
  .call(reporterTip)

  .on("mouseover", function(d) {
    reporterTip.show(d);
  })

  .on("mouseout", function(d) {
    reporterTip.hide(d);
  })



  var contextTip = d3.tip()
    .attr("class", "tooltip")
    .offset([-20,-5])
    .html(function(d,i) {
    var brushSelection = d3.brushSelection(contextBrush.node())
var formatTime = d3.timeFormat("%b %d %I:%M%p");

  return "Viewing " + formatTime(xScale2.invert(brushSelection[0])) + " ‚Äî <br>" + formatTime(xScale2.invert(brushSelection[1]))
    });

  contextChart.selectAll(".selection")
  .call(contextTip)

  .on("mousedown", function(d) {
    contextTip.hide(d);
  })

  .on("mouseover", function(d) {
    contextTip.show(d);
  })

  .on("mouseout", function(d) {
    contextTip.hide(d);
  })


});


function brushed() {
  if (d3.event.sourceEvent && d3.event.sourceEvent.type === "zoom") return; // ignore brush-by-zoom
  var s = d3.event.selection || xScale2.range();
  var formatTime = d3.timeFormat("%b %d %I:%M%p");
  var newDateRange = s.map(xScale2.invert, xScale2);
  for(var i = 0; i < newDateRange.length; i++) {
    newDateRange[i] = formatTime(newDateRange[i])
  }
  xScale.domain(s.map(xScale2.invert, xScale2));
  body.select("#context-description").html("Viewing " + newDateRange[0] + " ‚Äî " + newDateRange[1]);
  reporterChart.select(".moodArea").attr("d", moodArea);
  reporterChart.select(".moodLine").attr("d", moodLine);
  reporterChart.selectAll(".moodCircle").attr("cx", function(d) {return xScale(d.time)}).attr("cy", function(d) {return yScale(d.mood)});
  reporterChart.select(".moraleArea").attr("d", moraleArea);
  reporterChart.select(".stressArea").attr("d", stressArea);
  reporterChart.select(".fatigueArea").attr("d", fatigueArea);
  reporterChart.selectAll(".compulsion-x").attr("x", function(d) {return xScale(d.time)});
  keyloggerChart.selectAll(".joy-circle").attr("cx", function(d) {return xScale(d.time)}).attr("cy", function(d) {return yScaleKeylogger(d.score)});
  keyloggerChart.selectAll(".sad-circle").attr("cx", function(d) {return xScale(d.time)}).attr("cy", function(d) {return yScaleKeylogger(d.score)});
  keyloggerChart.selectAll(".tentative-circle").attr("cx", function(d) {return xScale(d.time)}).attr("cy", function(d) {return yScaleKeylogger(d.score)});
  keyloggerChart.selectAll(".angry-circle").attr("cx", function(d) {return xScale(d.time)}).attr("cy", function(d) {return yScaleKeylogger(d.score)});
  keyloggerChart.selectAll(".confident-circle").attr("cx", function(d) {return xScale(d.time)}).attr("cy", function(d) {return yScaleKeylogger(d.score)});
  keyloggerChart.selectAll(".analytical-circle").attr("cx", function(d) {return xScale(d.time)}).attr("cy", function(d) {return yScaleKeylogger(d.score)});
  keyloggerChart.selectAll(".disgust-circle").attr("cx", function(d) {return xScale(d.time)}).attr("cy", function(d) {return yScaleKeylogger(d.score)});
  keyloggerChart.selectAll(".fear-circle").attr("cx", function(d) {return xScale(d.time)}).attr("cy", function(d) {return yScaleKeylogger(d.score)});
  blinksChart.selectAll(".blink-circle").attr("cx", function(d) {return xScale(d.time)});
  expressionsChart.select(".productivityArea").attr("d", productivityArea);
  expressionsChart.selectAll(".attentionLines").attr("x1", function(d){ return xScale(d.time);}).attr("x2", function(d) {return xScale(d.time);});
  expressionsChart.selectAll(".valenceLines").attr("x1", function(d){ return xScale(d.time);}).attr("x2", function(d) {return xScale(d.time);});
  emojiChart.selectAll(".emoji").attr("transform", function(d) {return "translate(" + (xScale(d.time)-7) + ")";});
  tabCounterChart.select(".tabLine").attr("d", tabLine);
  // tabCounterChart.select(".windowLine").attr("d", windowLine);
 tabCounterChart.selectAll("rect").attr("x", function(d) { return xScale(dataset[d].timestamp); }).attr("width", (xScale(new Date("Sun Apr 29 2018 02:00:00 GMT-0500 (CDT)")) - xScale( new Date("Sun Apr 29 2018 01:00:00 GMT-0500 (CDT)"))));  tabCounterChart.selectAll(".tabCircle").attr("cx", function(d) {return xScale(dataset[d].timestamp)});
  tabCounterChart.selectAll(".windowCircle").attr("cx", function(d) {return xScale(dataset[d].timestamp)});
  body.selectAll(".axis--x").call(xAxis);
}


// function zoomed() {
//   if (d3.event.sourceEvent && d3.event.sourceEvent.type === "brush") return; // ignore zoom-by-brush
//   var t = d3.event.transform;
//   xScale.domain(t.rescaleX(xScale2).domain());
//   reporterChart.select(".moodArea").attr("d", moodArea);
//   reporterChart.select(".moodLine").attr("d", moodLine);
//   reporterChart.select(".moraleArea").attr("d", moraleArea);
//   reporterChart.selectAll(".moodCircle").attr("cx", function(d) {return xScale(d.time)}).attr("cy", function(d) {return yScale(d.mood)});
//   reporterChart.select(".stressArea").attr("d", stressArea);
//   reporterChart.select(".fatigueArea").attr("d", fatigueArea);
//   reporterChart.selectAll(".compulsion-x").attr("x", function(d) {return xScale(d.time)});
//   keyloggerChart.selectAll(".joy-circle").attr("cx", function(d) {return xScale(d.time)}).attr("cy", function(d) {return yScaleKeylogger(d.score)});
//   keyloggerChart.selectAll(".sad-circle").attr("cx", function(d) {return xScale(d.time)}).attr("cy", function(d) {return yScaleKeylogger(d.score)});
//   keyloggerChart.selectAll(".tentative-circle").attr("cx", function(d) {return xScale(d.time)}).attr("cy", function(d) {return yScaleKeylogger(d.score)});
//   keyloggerChart.selectAll(".angry-circle").attr("cx", function(d) {return xScale(d.time)}).attr("cy", function(d) {return yScaleKeylogger(d.score)});
//   keyloggerChart.selectAll(".confident-circle").attr("cx", function(d) {return xScale(d.time)}).attr("cy", function(d) {return yScaleKeylogger(d.score)});
//   keyloggerChart.selectAll(".analytical-circle").attr("cx", function(d) {return xScale(d.time)}).attr("cy", function(d) {return yScaleKeylogger(d.score)});
//   keyloggerChart.selectAll(".disgust-circle").attr("cx", function(d) {return xScale(d.time)}).attr("cy", function(d) {return yScaleKeylogger(d.score)});
//   keyloggerChart.selectAll(".fear-circle").attr("cx", function(d) {return xScale(d.time)}).attr("cy", function(d) {return yScaleKeylogger(d.score)});
//   blinksChart.selectAll(".blink-circle").attr("cx", function(d) {return xScale(d.time)});
//   expressionsChart.select(".productivityArea").attr("d", productivityArea);
//   expressionsChart.selectAll(".attentionLines").attr("x1", function(d){ return xScale(d.time);}).attr("x2", function(d) {return xScale(d.time);});
//   expressionsChart.selectAll(".valenceLines").attr("x1", function(d){ return xScale(d.time);}).attr("x2", function(d) {return xScale(d.time);});
//   emojiChart.selectAll(".emoji").attr("transform", function(d) {return "translate(" + (xScale(d.time)-7) + ")";});
//   body.selectAll(".axis--x").call(xAxis);
//   contextChart.select(".brush").call(brush.move, xScale.range().map(t.invertX, t));
// }

</script>
<script>

var keyloggerSVG = d3.select("#keylogger")
      .attr("width", width + margin.left + margin.right)
      .attr("height", height + margin.top + margin.bottom)
var keyloggerChart = keyloggerSVG.append("g")
        .attr("class", "keyloggerG")
        .attr("transform", "translate(" + margin.left + "," + margin.top + ")");


var yScaleKeylogger = d3.scaleLinear()
  .range([height,0]);
  // .domain([0.45,1]);
var yAxisKeylogger = d3.axisLeft(yScaleKeylogger).tickSize(-width).ticks(4).tickPadding(10).tickSizeOuter(0).tickFormat(function(d) { return d*100 + "%"; });



  d3.json("keylogger/logs/log_new.json", ready);

  function ready(err, data) {
      if (err) console.warn(err, "error loading data");

  data.forEach(function(d){
    var dateTime = new Date(d.unix_time * 1e3);
    d.time = dateTime;
  })


  var joy = [];
  var sadness = [];
  var confidence = [];
  var analytical = [];
  var anger = [];
  var disgust = [];
  var fear = [];
  var tentative = [];

  data.filter(function(d) {
    var holder;
    for(var i = 0; i < d.sentences_tone.length; i++) {
      if(d.sentences_tone[i].tones.length > 0) {
      for(var j = 0; j < d.sentences_tone[i].tones.length; j++) {
          if(d.sentences_tone[i].tones[j].tone_name == "Joy"){
            holder = d.sentences_tone[i].tones[j];
            holder["time"]=d.time;
            holder["sentence"]=d.sentences_tone[i].text;
            joy.push(holder);
            holder = "";
          }
          else if (d.sentences_tone[i].tones[j].tone_name == "Sadness"){
            holder = d.sentences_tone[i].tones[j];
            holder["time"]=d.time;
            holder["sentence"]=d.sentences_tone[i].text;
            sadness.push(holder);
            holder = "";
          }
          else if (d.sentences_tone[i].tones[j].tone_name == "Confident"){
            holder = d.sentences_tone[i].tones[j];
            holder["time"]=d.time;
            holder["sentence"]=d.sentences_tone[i].text;
            confidence.push(holder);
            holder = "";
          }
          else if (d.sentences_tone[i].tones[j].tone_name == "Analytical"){
            holder = d.sentences_tone[i].tones[j];
            holder["time"]=d.time;
            holder["sentence"]=d.sentences_tone[i].text;
            analytical.push(holder);
            holder = "";
          }
          else if (d.sentences_tone[i].tones[j].tone_name == "Anger"){
            holder = d.sentences_tone[i].tones[j];
            holder["time"]=d.time;
            holder["sentence"]=d.sentences_tone[i].text;
            anger.push(holder);
            holder = "";
          }
          else if (d.sentences_tone[i].tones[j].tone_name == "Disgust"){
            holder = d.sentences_tone[i].tones[j];
            holder["time"]=d.time;
            holder["sentence"]=d.sentences_tone[i].text;
            disgust.push(holder);
            holder = "";
          }
          else if (d.sentences_tone[i].tones[j].tone_name == "Fear"){
            holder = d.sentences_tone[i].tones[j];
            holder["time"]=d.time;
            holder["sentence"]=d.sentences_tone[i].text;
            fear.push(holder);
            holder = "";
          }
          else if (d.sentences_tone[i].tones[j].tone_name == "Tentative"){
            holder = d.sentences_tone[i].tones[j];
            holder["time"]=d.time;
            holder["sentence"]=d.sentences_tone[i].text;
            tentative.push(holder);
            holder = "";
          }
        }
      }
    }
  });



  var tip = d3.tip()
    .attr("class", "tooltip")
    .offset([-20,-5])
    .html(function(d,i) {
    return "<b>" + d.tone_name + "</b>: " + d.sentence;
    });

  // xScale.domain(d3.extent(newResponses, function(d) {return d.time;}));
  yScaleKeylogger.domain([0.45,1]);
  // xScale2.domain(xScale.domain());
  // yScale2.domain(yScale.domain());

  keyloggerChart.append("g")
    .attr("class", "axis axis--x")
    .attr("transform","translate(0, "+(height)+")")
    .call(xAxis);

  keyloggerChart.append("g")
  .attr("class", "axis axis--y")
    .call(yAxisKeylogger);




    var joyCircles = keyloggerChart.selectAll(".joy-circle")
      .data(joy)
      .enter()
      .append("circle")
      .attr("class","joy-circle")
      .attr("cx", function(d) {return xScale(d.time)})
      .attr("cy", function(d) {return yScaleKeylogger(d.score)})
      .attr("r", function(d) { return d.sentence.length / 10;})
      .attr("fill-opacity", function(d) { return Math.pow(d.score, 3);})
      .attr("fill", "fuchsia");

    var confidentCircles = keyloggerChart.selectAll(".confident-circle")
      .data(confidence)
      .enter()
      .append("circle")
      .attr("class", "confident-circle")
      .attr("cx", function(d) {return xScale(d.time)})
      .attr("cy", function(d) {return yScaleKeylogger(d.score)})
      .attr("r", function(d) { return d.sentence.length / 10;})

      // .attr("r", function(d) { return Math.pow(d.score, 3) * 20;})
      .attr("fill-opacity", function(d) { return Math.pow(d.score, 3);})
      .attr("fill", "springgreen");

    var analyticalCircles = keyloggerChart.selectAll(".analytical-circle")
      .data(analytical)
      .enter()
      .append("circle")
      .attr("class", "analytical-circle")
      .attr("cx", function(d) {return xScale(d.time)})
      .attr("cy", function(d) {return yScaleKeylogger(d.score)})
      .attr("r", function(d) { return d.sentence.length / 10;})

      // .attr("r", function(d) { return Math.pow(d.score, 3) * 20;})
      .attr("fill-opacity", function(d) { return Math.pow(d.score, 3);})
      .attr("fill", "gold");

    var tentativeCircles = keyloggerChart.selectAll(".tentative-circle")
      .data(tentative)
      .enter()
      .append("circle")
      .attr("class", "tentative-circle")
      .attr("cx", function(d) {return xScale(d.time)})
      .attr("cy", function(d) {return yScaleKeylogger(d.score)})
      .attr("r", function(d) { return d.sentence.length / 10;})

      // .attr("r", function(d) { return Math.pow(d.score, 3) * 20;})
      .attr("fill-opacity", function(d) { return Math.pow(d.score, 3);})
      .attr("fill", "lavender");

    var sadCircles = keyloggerChart.selectAll(".sad-circle")
      .data(sadness)
      .enter()
      .append("circle")
      .attr("class", "sad-circle")
      .attr("cx", function(d) {return xScale(d.time)})
      .attr("cy", function(d) {return yScaleKeylogger(d.score)})
      .attr("r", function(d) { return d.sentence.length / 10;})

      // .attr("r", function(d) { return Math.pow(d.score, 3) * 20;})
      .attr("fill-opacity", function(d) { return Math.pow(d.score, 3);})
      .attr("fill", "cyan");

    var fearCircles = keyloggerChart.selectAll(".fear-circle")
      .data(fear)
      .enter()
      .append("circle")
      .attr("class", "fear-circle")
      .attr("cx", function(d) {return xScale(d.time)})
      .attr("cy", function(d) {return yScaleKeylogger(d.score)})
      .attr("r", function(d) { return d.sentence.length / 10;})

      // .attr("r", function(d) { return Math.pow(d.score, 3) * 20;})
      .attr("fill-opacity", function(d) { return Math.pow(d.score, 3);})
      .attr("fill", "blue");

    var angryCircles = keyloggerChart.selectAll(".angry-circle")
      .data(anger)
      .enter()
      .append("circle")
      .attr("class", "angry-circle")
      .attr("cx", function(d) {return xScale(d.time)})
      .attr("cy", function(d) {return yScaleKeylogger(d.score)})
      .attr("r", function(d) { return d.sentence.length / 10;})

      // .attr("r", function(d) { return Math.pow(d.score, 3) * 20;})
      .attr("fill-opacity", function(d) { return Math.pow(d.score, 3);})
      .attr("fill", "deeppink");

    var disgustCircles = keyloggerChart.selectAll(".disgust-circle")
      .data(disgust)
      .enter()
      .append("circle")
      .attr("class", "disgust-circle")
      .attr("cx", function(d) {return xScale(d.time)})
      .attr("cy", function(d) {return yScaleKeylogger(d.score)})
      .attr("r", function(d) { return Math.pow(d.score, 3) * 20;})
      .attr("fill-opacity", 0.25)
      .attr("fill", "thistle");



    keyloggerSVG.selectAll("circle")
    .call(tip)

    .on("mouseover", function(d) {
      tip.show(d);
    })

    .on("mouseout", function(d) {
      tip.hide(d);
    })


}
  </script>

<script>

var affectivaHeight = 850;
var affectivaSVG = d3.select("#affectiva")
      .attr("width", width + margin.left + margin.right)
      .attr("height", affectivaHeight + margin.top + margin.bottom);

var blinksHeight = (affectivaHeight/10) * 2;
var blinksChart = affectivaSVG.append("g")
        .attr("height", blinksHeight)
        .attr("class", "blinksG")
        .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

var expressionsHeight = (affectivaHeight/10) * 5;
var expressionsChart = affectivaSVG.append("g")
        .attr("height", expressionsHeight)
        .attr("class", "expressionsG")
        .attr("transform", "translate(" + margin.left + "," + (blinksHeight + margin.top) + ")");

var emojiHeight = (affectivaHeight/10) * 3;
var emojiChart = affectivaSVG.append("g")
        .attr("height", emojiHeight)
        .attr("class", "emojiG")
        .attr("transform", "translate(" + margin.left + "," + (expressionsHeight + blinksHeight + 90 + margin.top) + ")");

var yScaleExpressions = d3.scaleLinear()
  .range([expressionsHeight,0]);
var yAxisExpressions = d3.axisLeft(yScaleExpressions).tickSize(-width).ticks(4).tickPadding(10).tickSizeOuter(0).tickFormat(function(d) { return d + "%"; });


var productivityArea = d3.area()
    .x(function(d) { return xScale(d[0]); })
    .y1(function(d) { return yScaleExpressions(d[4]); })
    .y0(expressionsHeight/2)
      .defined(function(d){return d[4]!=null;});


d3.json("affectiva/analyses/merged_file.json", function (err, affectiva) {
  d3.json("getAPIdata/productivity.json", function(err, rescuetime){
      if (err) console.warn(err, "error loading data");


productivity = rescuetime.rows;

productivity.forEach(function(d){
  var dateTime = new Date(String(d[0]) + "-04:00");
  d[0] = dateTime;
})

newProductivity = [];

productivity.forEach(function(d, i){

  newProductivity.push(d);

  if(i == productivity.length-1){
    return;
  }
  var timee = productivity[i+1][0];


  if(d[0] < (timee - 3600000)) {
    var nullTime = new Date(timee - 3600000);
    var nullItems = [];
    nullItems[0] = nullTime;
    nullItems[1] = null;
    nullItems[2] = null;
    nullItems[3] = null;
    nullItems[4] = null;
    var nullIndex = i+1;
    newProductivity.push(nullItems);

  }

});


affectiva.sort(function(a,b) {return a.time - b.time});


affectiva.forEach(function(d){

    var dateTime = new Date(d.time);
    d.time = dateTime;
})



    // var attentionLine = d3.svg.line()
    //   .x(function(d) {return xScale(d.time);})
    //   .y(function(d){return yScale(d.attention);});
    //


// xScale.domain(d3.extent(newResponses, function(d) {return d.time;}));
  yScaleExpressions.domain([-100,100]);
  // xScale2.domain(xScale.domain());
  // yScale2.domain(yScale.domain());


  // var productivityline = d3.line()
  //   .defined(function(d){return d[4]!=null;})
  //   .x(function(d) {return xScale(d[0]);})
  //   .y(function(d){return yScaleExpressions(d[4]);});

  // var blinkLine = d3.svg.line()
  //   .defined(function(d){return d.blinks!=null;})
  //   .x(function(d) {return xScale(d.time);})
  //   .y(function(d){return yScale(d.blinks);});


  var blinksTip = d3.tip()
    .attr("class", "tooltip")
    .offset([-22,-5])
    .direction("n")
    .html(function(d,i) {
    return d.blinks + " blinks";
    });



  var attentionTip = d3.tip()
    .attr("class", "tooltip")
    .offset([-24,-5])
    .html(function(d,i) {
    return "<b>Max Attention:</b> " + d.max_attention.toFixed(2) + "% <br><b>Min Attention:</b> " + d.min_attention.toFixed(2) + "%";
    });


  var valenceTip = d3.tip()
    .attr("class", "tooltip")
    .offset([22,-5])
    .direction("s")
    .html(function(d,i) {
    return "<b>Max Valence:</b> " + d.max_valence.toFixed(2) + "% <br><b>Min Valence:</b> " + d.min_valence.toFixed(2) + "% <p><span style='font-size:16px'>" + d.emoji + "</span></p>";
    });

  var markers = [
   { id:0, name: 'attention', path: 'M 0,0 m -1,-4.5 L 1,-4.5 L 1,4.5 L -1,4.5 Z', fill: 'fuchsia', viewbox: '-1 -5 2 10' },
   { id: 1, name: 'engagement', path: 'M 0,0 m -1,-2.5 L 1,-2.5 L 1,2.5 L -1,2.5 Z', fill: 'gold', viewbox: '-1 -5 2 10' },
   { id: 2, name: 'valence', path: 'M 0,0 m -1,-4.5 L 1,-4.5 L 1,4.5 L -1,4.5 Z', fill: 'cyan', viewbox: '-1 -5 2 10' },
  ]


    var defs = affectivaSVG.append('svg:defs')

  var marker = defs.selectAll('marker')
    .data(markers)
    .enter()
    .append('svg:marker')
      .attr('id', function(d){ return 'marker_' + d.name})
      .attr('markerHeight', 5)
      .attr('markerWidth', 5)
      .attr('markerUnits', 'strokeWidth')
      .attr('orient', 'auto')
      .attr('refX', 0)
      .attr('refY', 0)
      .attr('viewBox', function(d){ return d.viewbox })
      .append('svg:path')
        .attr('d', function(d){ return d.path })
        .attr("fill", function(d){return d.fill})
        .attr("fill-opacity", 0.3);


  blinksChart.append("line")
    .style("stroke", "silver")
    .style("stroke-width", 1)
    .attr("x1", 60)
    .attr("y1", 60)
    .attr("x2", width)
    .attr("y2", 60);

  blinksChart.append("text")
    .attr("class", "alt-axis")
    .attr("y", 60)
    .attr("x", -30)
    .text("BLINKS/MIN");

  var blinkCircles = blinksChart.selectAll(".blink-circle")
    .data(affectiva)
    .enter()
    .append("circle")
    .attr("class","blink-circle")
    .attr("cx", function(d) {return xScale(d.time)})
    .attr("cy", 60)
    .attr("r", function(d) { return d.blinks * 1.5;})
    .attr("fill-opacity", 0.6)
    .attr("fill", "blue");



    blinksChart.selectAll(".blink-circle")
    .call(blinksTip)

    .on("mouseover", function(d) {
      blinksTip.show(d);
    })

    .on("mouseout", function(d) {
      blinksTip.hide(d);
    })



  expressionsChart.append("g")
    .attr("class", "axis axis--x")
    .attr("transform","translate(0, "+expressionsHeight+")")
    .call(xAxis);

  expressionsChart.append("g")
  .attr("class", "axis axis--y")
    .call(yAxisExpressions);


  expressionsChart.append("line")
    .style("stroke", "#e0e0e0")
    .style("stroke-dasharray", ("5,5"))
    .attr("x1", 0)
    .attr("y1", yScaleExpressions(50))
    .attr("x2", width)
    .attr("y2", yScaleExpressions(50));




 expressionsChart.append("path")
    .datum(newProductivity)
    .attr("d", productivityArea)
    .attr("fill", "gold")
    .attr("opacity", 0.35)
    .attr("class", "productivityArea");



    var valenceLines = expressionsChart.selectAll(".valenceLines")
    .data(affectiva)
    .enter()
    .append("line")
    .attr("class", "valenceLines")
    .attr("stroke", "cyan")
    .attr("stroke-width", 2.25)
    .attr("stroke-opacity", 0.6)
    .attr("x1", function(d){ return xScale(d.time);})
    .attr("x2", function(d) {return xScale(d.time);})
    .attr("y1", function(d){return yScaleExpressions(d.min_valence)})
    .attr("y2", function(d) {return yScaleExpressions(d.max_valence)})
    .attr('marker-start', 'url(#marker_valence)')
    .attr('marker-end', 'url(#marker_valence)');

    var attentionLines = expressionsChart.selectAll(".attentionLines")
    .data(affectiva)
    .enter()
    .append("line")
    .attr("class", "attentionLines")
    .attr("stroke", "fuchsia")
    .attr("stroke-width", 2.25)
    .attr("stroke-opacity", 0.6)
    // .attr("stroke-linecap", "butt")
    .attr("x1", function(d){ return xScale(d.time);})
    .attr("x2", function(d) {return xScale(d.time);})
    .attr("y1", function(d){return yScaleExpressions(d.min_attention)})
    .attr("y2", function(d) {return yScaleExpressions(d.max_attention)})
    .attr('marker-start', 'url(#marker_attention)')
    .attr('marker-end', 'url(#marker_attention)');




  expressionsChart.selectAll(".attentionLines")
  .call(attentionTip)

  .on("mouseover", function(d) {
    attentionTip.show(d);
  })

  .on("mouseout", function(d) {
    attentionTip.hide(d);
  })


  expressionsChart.selectAll(".valenceLines")
  .call(valenceTip)

  .on("mouseover", function(d) {
    valenceTip.show(d);
  })

  .on("mouseout", function(d) {
    valenceTip.hide(d);
  })



  emojiChart.append("line")
    .style("stroke", "silver")
    .style("stroke-width", 1)
    .attr("x1", 70)
    .attr("y1", 110)
    .attr("x2", width)
    .attr("y2", 110);

  emojiChart.append("text")
    .attr("class", "alt-axis")
    .attr("y", 110)
    .attr("x", -30)
    .text("EXPRESSIONS");

    var j = 0;
    var k = 0;

    var emoji = emojiChart.selectAll(".emoji")
      .data(affectiva)
      .enter()
      .append("g")
      .attr("class", "emoji")
      .attr("transform", function(d) {
        return "translate(" + (xScale(d.time)-7) + ")";})
      .selectAll(".emoji")
      .data(function(d) {
        return d.emoji;
      })
      .enter()
      .append("g")
      .attr("transform", function(d,i) {
        if (i == 0) {
          j = 0;
          k = 0;
        }
        if (d <= "üòè" || d >= "üòò" && d <="üòù" || d == "üòó") { //happy
          var translate_string = "translate(0," + (yScaleExpressions(j*19)/2.5) + ")";
          j += 1;
          return translate_string;
        }
        else if (d > "üòè" && d < "üòò" || d > "üòù") { //sad
          var translate_string = "translate(0," + (235 - yScaleExpressions(k*19)/2.5) + ")";
          k += 1;
          return translate_string;
        }
      })
      .append("text")
      .text(function(d) {return d;})
        .attr("font-size", "18px");



})
});

</script>


<script>

var dataset; 
// var tabCounterChartHeight = 800;
// var tabCounterHeight = 500;
// var faviconHeight = 300;

var tabCounterSVG = d3.select("#tabCounter")
      .attr("width", width + margin.left + margin.right)
      .attr("height", height + margin.top + margin.bottom);
var tabCounterChart = tabCounterSVG.append("g")
      .attr("class", "tabCounterG")
      .attr("transform", "translate(" + margin.left + "," + margin.top + ")");
      // .attr("height", tabCounterHeight);
// var faviconChart = tabCounterSVG.append("g")
//       .attr("class", "faviconG")
//       .attr("transform", "translate(" + margin.left + "," + (margin.top + faviconHeight) + ")")
//       .attr("height", faviconHeight);


var yScaleTabCounter = d3.scaleLinear()
  .range([height,0]);
  // .domain([0.45,1]);
var yAxisTabCounter = d3.axisLeft(yScaleTabCounter).tickSize(-width).ticks(4).tickPadding(10).tickSizeOuter(0);


var tabLine = d3.line()
// .defined(function(d) { return (typeof dataset[d].current_tabCount !== 'string'); })
.defined(function(d){
    // return dataset[d].current_tabCount!==null ? d : console.log("null")
  return (dataset[d].current_tabCount!==null) && (dataset[d].tabs_activated > 0 || dataset[d].tabs_created > 0)
})
  .x(function(d) {return xScale(dataset[d].timestamp);})
  .y(function(d){return yScaleTabCounter(dataset[d].current_tabCount);});




d3.json("getAPIdata/chromeactivity.json", ready);

function ready(err, data) {
    if (err) console.warn(err, "error loading data");


dataset = data;

// console.log(dataset[1524982083090])
var keyLookup = [];

for(var key in dataset){
  // console.log(dataset[key])
  var dateTime = new Date(dataset[key].timestamp)
  dataset[key].timestamp = dateTime;
  keyLookup.push(key);

  if(!dataset[key].favicons){
    dataset[key]["favicons"] = [];
  }
}


for(var key in dataset){

  var currentIndex = keyLookup.indexOf(key);

  if(currentIndex < keyLookup.length - 1){
    var currentTime = dataset[key].timestamp;
    var nextTime = dataset[keyLookup[currentIndex+1]].timestamp;


    if (currentTime < (nextTime - 14000000)) {
      var nullTime = nextTime - 14000000

      var nullItems = {};

      nullItems["timestamp"] = new Date(nullTime);
      nullItems["current_windowCount"] = null;
      nullItems["current_tabCount"] = null;
      nullItems["favicons"] = [];
      nullItems["tabs_activated"] = null;
      nullItems["tabs_created"] = null;
      nullItems["windows_created"] = null;

      dataset[nullTime] = nullItems;
    }

    // else if (currentTime > (nextTime - 1800000)) {
    //   var currentTimeMs = currentTime.getTime();
    //   var nextTimeMs = nextTime.getTime();
    //   dataset[currentTimeMs].tabs_activated += dataset[nextTimeMs].tabs_activated;
    //   dataset[currentTimeMs].tabs_created += dataset[nextTimeMs].tabs_created;
    //   dataset[currentTimeMs].windows_created += dataset[nextTimeMs].windows_created;
    //   delete dataset[nextTimeMs];
    // }
  }
}


keyLookup = [];

for(var key in dataset){
    keyLookup.push(key);
}

keyLookup.sort(function(a,b){
  return a - b;
})


var yMax = d3.extent(keyLookup, function(d) {return dataset[d].tabs_activated;})[1];
yScaleTabCounter.domain([0,yMax]);
// xScale2.domain(xScale.domain());
// yScale2.domain(yScale.domain());


  var tabTip = d3.tip()
    .attr("class", "tooltip")
    .offset([-22,-5])
    .direction("n")
    .html(function(d) {
      var imgString = "";
      for(var i = 0; i < dataset[d].favicons.length; i++){
        var jnURL = "http://localhost:8888/static/base/images/"
        if(dataset[d].favicons[i].includes(jnURL)){
        imgString += "<img src='tabcounter/"+dataset[d].favicons[i].slice(jnURL.length)+"' width='13px' height='13px'>"
        }
        else{
        imgString += "<img src='"+dataset[d].favicons[i]+"' width='13px' height='13px'>"
        }
      }
      return "<b>Tabs Activated:</b> "+dataset[d].tabs_activated+"<br><br>" + imgString;
    });

  var tabCreatedTip = d3.tip()
    .attr("class", "tooltip")
    .offset([-22,-5])
    .direction("n")
    .html(function(d) {
      return "<b>Tabs Created:</b> "+dataset[d].tabs_created;
    });

  var tabCountTip = d3.tip()
    .attr("class", "tooltip")
    .offset([-22,-5])
    .direction("n")
    .html(function(d) {
      return "<b>Tabs Left Open:</b> "+dataset[d].current_tabCount;
    });

  var windowCountTip = d3.tip()
    .attr("class", "tooltip")
    .offset([-22,-5])
    .direction("n")
    .html(function(d) {
      return "<b>Windows Left Open:</b> "+dataset[d].current_windowCount;
    });



  tabCounterChart.append("g")
    .attr("class", "axis axis--x")
    .attr("transform","translate(0, "+(height)+")")
    .call(xAxis);

  tabCounterChart.append("g")
  .attr("class", "axis axis--y")
    .call(yAxisTabCounter);


var pixelInterval = xScale(new Date("Sun Apr 29 2018 02:00:00 GMT-0500 (CDT)")) - xScale( new Date("Sun Apr 29 2018 01:00:00 GMT-0500 (CDT)"));


 tabCounterChart.selectAll(".activated-bar")
      .data(keyLookup)
    .enter().append("rect")
      .attr("class", "activated-bar")
      .style("fill", "gold")
      .style("opacity", 0.5)
      .attr("x", function(d) { return xScale(dataset[d].timestamp); })
      .attr("width", pixelInterval)
      .attr("y", function(d) { return yScaleTabCounter(dataset[d].tabs_activated); })
      .attr("height", function(d) { return height - yScaleTabCounter(dataset[d].tabs_activated); });

tabCounterChart.selectAll(".created-bar")
    .data(keyLookup)
  .enter().append("rect")
    .attr("class", "created-bar")
    .style("fill", "cyan")
    .style("opacity", 0.5)
    .attr("x", function(d) { return xScale(dataset[d].timestamp); })
    .attr("width", pixelInterval)
    .attr("y", function(d) { return yScaleTabCounter(dataset[d].tabs_created); })
    .attr("height", function(d) { return height - yScaleTabCounter(dataset[d].tabs_created); });

tabCounterChart.append("path")
  .datum(keyLookup)
  .attr("d", tabLine)
  .attr("stroke", "magenta")
  .attr("stroke-width", 2)
  .attr("fill", "none")
  .attr("class", "tabLine")
  .attr("opacity", 0.6);

// tabCounterChart.append("path")
//   .datum(keyLookup)
//   .attr("d", windowLine)
//   .attr("stroke", "blue")
//   .attr("stroke-width", 2)
//   .attr("fill", "none")
//   .attr("class", "windowLine")
//   .attr("opacity", 0.6);

tabCounterChart.selectAll(".tabCircle")
  .data(keyLookup)
  .enter()
  .append("circle")
  .attr("class","tabCircle")
  .attr("cx", function(d) {return xScale(dataset[d].timestamp)})
  .attr("r", function(d) {return (dataset[d].current_tabCount == null || dataset[d].tabs_activated == 0) ? 0 : 2; })
  .attr("cy", function(d) { return yScaleTabCounter(dataset[d].current_tabCount);})
  .attr("opacity", 0.7)
  .attr("fill", "magenta");


// tabCounterChart.selectAll(".windowCircle")
//   .data(keyLookup)
//   .enter()
//   .append("circle")
//   .attr("class","windowCircle")
//   .attr("cx", function(d) {return xScale(dataset[d].timestamp)})
//   .attr("r", function(d) {return dataset[d].current_windowCount == null ? 0 : 3; })
//   .attr("cy", function(d) { return yScaleTabCounter(dataset[d].current_windowCount);})
//   .attr("opacity", 0.65)
//   .attr("fill", "blue");

// faviconChart.selectAll(".chromeIcons")
//   .data(keyLookup)
//   .enter()
//   .append("g")
//   .attr("transform", function(d){return "translate(" + xScale(dataset[d].timestamp) +")"})
//   .selectAll(".icons")
//   .data(function(d) {return dataset[d].favicons;})
//   .enter()
//   .append("svg:image")
//   // .attr("class", "logo")
//   // .attr("cx", function(d){return xScale(d.time)})
//   // .attr("cy", height)
//   .attr("xlink:href", function(d,i){return d;})
//   .attr("transform", function(d,j){return "translate(0," + yScaleTabCounter((j+2)*2) + ")";})
//   .attr("height", 10)
//   .attr("width", 10);


tabCounterChart.selectAll(".activated-bar")
.call(tabTip)

.on("mouseover", function(d) {
  tabTip.show(d);
})

.on("mouseout", function(d) {
  tabTip.hide(d);
})


tabCounterChart.selectAll(".created-bar")
.call(tabCreatedTip)

.on("mouseover", function(d) {
  tabCreatedTip.show(d);
})

.on("mouseout", function(d) {
  tabCreatedTip.hide(d);
})


tabCounterChart.selectAll(".tabCircle")
.call(tabCountTip)

.on("mouseover", function(d) {
  tabCountTip.show(d);
})

.on("mouseout", function(d) {
  tabCountTip.hide(d);
})


// tabCounterChart.selectAll(".windowCircle")
// .call(windowCountTip)

// .on("mouseover", function(d) {
//   windowCountTip.show(d);
// })

// .on("mouseout", function(d) {
//   windowCountTip.hide(d);
// })

}

// });



</script>

</body>
