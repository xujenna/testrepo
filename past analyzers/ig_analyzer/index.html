<!DOCTYPE html>
<meta charset="utf-8">

<style type="text/css">
/*css to go here*/
body {
  font-family: monospace;
  font-size: 12px;
}

.yAxis line,
.yAxis path {
  fill:none;
  stroke:silver;
}

.yAxis .tick line {
  stroke-dasharray: 1px 2px;
}

.yAxis text {
  text-align:right;
  font-size:10px;
}

.xAxis line,
.xAxis path {
  fill:none;
  stroke:silver;

}

.xAxis text {
  transform: rotate(-45deg) translateX(-10px) translateY(-2px);
  text-align:right;
  /*  text-transform:uppercase;
  */  text-anchor:end !important;
  font-size:11px;
}

.title {
  text-align: center;
  font-family: monospace;
  font-size:18pt;
  margin-bottom:10px;
  margin-top:110px;
}

.button-container {
  text-align: center;
  margin-bottom: 10px;
}
.date-buttons {
  font-family:monospace;
  border: 0.5px solid silver;
  padding: 8px 9px;
  width:100px;
  height:40px;
  text-align:center;
  background-color:white;
  cursor: pointer;
  font-size:14px;
  margin-right:4px;
  margin-left:4px;
}

.date-buttons:hover {
  background-color: silver;
  color:white;
}

.date-buttons:active {
  transform: translateY(1px);
  box-shadow: none;
}

.date-buttons:focus {
  outline:none;
}

.photoDiv {
  margin-right:300px;
  margin-left:300px;
  text-align: center;
}


.tooltip {
  width: 110px;
  font-size:12px;
  font-family:monospace;
  background:rgba(255,255,255,0.85);
  padding:5px;
  line-height:1.25;
  clear:both;
  text-align: center;
}

.tooltip:after {
  font-size:18px;
  width: 110px;
  line-height:1.5;
  color: black;
  content: "\2193";
  position:absolute;
  text-align:center;
  display:block;
  pointer-events:none;
}

.intro {
  width: 1000px;
  margin: auto;
  font-family: roboto;
  font-size: 11pt;
  line-height: 18pt;
  margin-bottom: 100px;
  column-count:3;
  column-gap:25px;
  margin-top:75px;
}

.explanation {
  width: 700px;
  margin: auto;
  font-family: roboto;
  font-size: 11pt;
  line-height: 18pt;
  margin-top: 25px;
  margin-bottom: 40px;
  text-align: center;
}

.intro_images {
  margin: auto;
  text-align: center;
  width:900px;
  margin-top:100px;
}

.intro_images img {
  margin:2px;
  width:25%
}

.break {
  margin:auto;
  text-align: center;
  width:700px;
}

.footer {
  padding-top:60px;
  padding-bottom: 20px;
  margin:auto;
  text-align: center;
}
</style>

<body>
  <div class="intro_images"><img src="https://scontent-lga3-1.cdninstagram.com/vp/493819f3990c8667033f1d1684ed3efd/5B416156/t51.2885-15/e15/1737370_281904085295389_1913153407_n.jpg"><img src="https://scontent-lga3-1.cdninstagram.com/vp/2834da35079827b1455b0430a1a5c50a/5B2AB12A/t51.2885-15/e15/11296698_905908749476157_819136658_n.jpg"><img src="https://scontent-lga3-1.cdninstagram.com/vp/d8f17ab17c02a1a2ccefdb34cbb34128/5B4732F1/t51.2885-15/e15/10362273_295687197258383_125605912_n.jpg"></div>
  <div class="intro">Inspired by <a href="https://arxiv.org/pdf/1608.03282.pdf" target="new">Reece and Danforth's 2016 study</a> on the predictive markers of depression in Instagram activity, I've been running some tests on my photographic archive to see if it can map my own history with depression, which peaked in 2013 and has improved gradually since.
    <p>The markers considered in the study include the presence of people, the setting (indoors vs outsdoors), time of day, average pixel color, brightness, comments vs "likes" ratio, filters, and posting frequency.
    I used <a href="https://clarifai.com/" target="new">Clarifai's</a> General Model to identify subject matter, as well as their Color Model to determine a photo's dominant colors.</p>
    <p>Since I knew my Instagram activity wasn't typical for most users, I started my experiments with a <a href="http://www.xujenna.com/itp_blog/2018/02/22/two-more-years/" target="new">limited study on my Flickr photostream</a> with the General Model; the results were encouraging and extremely telling.
    Clarifai's generous 100,000 operation donation to my cause allowed me to analyze my entire Instgram history with both the General and Color Models, the results of which thus far are below. For my dataset, the most predictive marker for depression seems to be activity: I posted the most during 2013, while I was severely depressed, and posted less as my mood improved.</p>
  <p><b>Next steps</b> are visualizing the sentiment analysis I've run my captions, analyzing the comments/likes ratio, calculating and mapping a depression "score" based on the study's correlations, and looking for filters in Instagram's metadata.</p>
  <p>This is a proof of concept for a service design idea—developed for a proposal for the Open Seventeen Challenge—which is <a href="http://www.xujenna.com/itp_blog/2018/02/26/846/" target="new">mapped out here</a>.</p>
  </div>
  <div class="break"><hr></div>
  <div class="color-container">
    <div class ="color-chart">
      <div class="title">Dominant Colors on My Instagram, 2013-2016</div>
      <div class="explanation">In the 2016 Reece and Danforth study, increased hue, and decreased brightness and saturation in photos predicted depression. Clarifai's color analysis on my Instagram posts certainly returned results that were much darker and less colorful during the period I was acutely depressed (2013); the colors also seem to lift along with my mood as time progresses along the x-axis, albeit still rather grey. The below visualization displays the top two most dominant hex colors per post.</div>
    </div>
  </div>
  <div class="break"><hr></div>
  <div class="concept-container">
    <div class ="concept-chart">
      <div class="title" id="concept-title">Top 20 Concepts Instagrammed in 2013</div>
      <div class="explanation">In the Reece and Danforth study, depressed users were more likely to post photos of people, but had less per post than usual; this was definitely reflected in my posts, as the "people" category drops from second place in 2013 until it disappears completely in 2016 (you can also tell my photos contained less people from the presence of the "one" category). Additionally, the concepts "outdoors" and "travel" slowly move up the list as I start to feel better.</div><div style="text-align:center; margin-bottom:20px;"> Choose a year below to see its corresponding concept breakdown;<br>click on a bar to see its included photographs.</div>
      <div class="button-container"></div>
    </div>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/3.5.5/d3.min.js" charset="utf-8"></script>
  <script src="jquery-3.3.1.js"></script>
  <script src="http://labratrevenge.com/d3-tip/javascripts/d3.tip.v0.6.3.js"></script>

  <div class="photoDiv"></div>

  <div class="footer"><p>For further documentation, please see my <a href="http://www.xujenna.com/itp_blog/2018/02/22/two-more-years/" target="new">Flickr analysis</a>.</p>
  <p>For my concomitant service design sketch, please <a href="http://www.xujenna.com/itp_blog/2018/02/26/846/" target="new">click here</a>.
  <p>For the source code, please <a href="https://github.com/xujenna/thesis_explorations/tree/master/past%20analyzers/ig_analyzer" target="new">visit the repo.</a></p></div>
  <script>
  //JS to go here



d3.json("ig_to_clarifai.json", ready);
var margin = {top: 0, right: 300, bottom: 150, left: 300};


var conceptChart = d3.select(".concept-chart");
var colorChart = d3.select(".color-chart");

var width = conceptChart.node().clientWidth - margin.left - margin.right,
height = 600 - margin.top - margin.bottom;

var colorChartHeight = 1300;

var conceptSVG = conceptChart.append("svg")
.attr("width", width + margin.left + margin.right)
.attr("height", height + margin.top + margin.bottom)
.append("g")
.attr("transform", "translate(" + margin.left + "," + margin.top + ")");

var colorSVG = colorChart.append("svg")
.attr("width", width + margin.left + margin.right)
.attr("height", colorChartHeight + margin.top + margin.bottom)
.append("g")
.attr("transform", "translate(" + margin.left + "," + margin.top + ")");
// .attr("transform", "rotate(90," + width/2 + ","+ height*2 + ")");


function ready(err, data) {
    if (err) console.warn(err, "error loading data");

// DATA BY CONCEPTS

    var concepts2016 = [];
    var concepts2015 = [];
    var concepts2014 = [];
    var concepts2013 = [];
    var concepts2012 = [];

    data.forEach(function(d){
      var currentImage = d.display_src;
      var currentConcepts = d.general_predictions;
      for(var i=0; i<20; i++){
        if(d.date < "2017-01-01 00:00:00" && d.date > "2016-01-01 00:00:00"){
          currentConcepts[i]['url'] = currentImage;
          concepts2016.push(currentConcepts[i]);
        };
        if(d.date < "2016-01-01 00:00:00" && d.date > "2015-01-01 00:00:00"){
          currentConcepts[i]['url'] = currentImage;
          concepts2015.push(currentConcepts[i]);
        };
        if(d.date < "2015-01-01 00:00:00" && d.date > "2014-01-01 00:00:00"){
          currentConcepts[i]['url'] = currentImage;
          concepts2014.push(currentConcepts[i]);
        };
        if(d.date < "2014-01-01 00:00:00" && d.date > "2013-01-01 00:00:00"){
          currentConcepts[i]['url'] = currentImage;
          concepts2013.push(currentConcepts[i]);
        };
        if(d.date < "2013-01-01 00:00:00" && d.date > "2012-01-01 00:00:00"){
          currentConcepts[i]['url'] = currentImage;
          concepts2012.push(currentConcepts[i]);
        };
      };
    });


    concepts_list = [concepts2013, concepts2014, concepts2015, concepts2016]
    uniqueconcepts_list = []
    topconcepts_list = []

    for(var i = 0; i < concepts_list.length; i++) {

      var uniqueconcepts = d3.nest()
      .key(function(d) {return d.name;})
      // .key(function(d){return d.url;})
      .entries(concepts_list[i]);

      uniqueconcepts_list.push(uniqueconcepts);

      var topconcepts = uniqueconcepts
      .sort(function(a,b) { return b.values.length-a.values.length;})
      .filter(function(d,i){return i < 20;})

      topconcepts_list.push(topconcepts);
    }


    var concept_yMin = d3.min(topconcepts_list[0],function(d,i){return d.values.length;});
    var concept_yMax = d3.max(topconcepts_list[0],function(d,i){return d.values.length;});

    var concept_xScale = d3.scale.ordinal()
    .rangeRoundBands([0,width], .1)
    .domain(topconcepts_list[0].map(function(d){return d.key;}));

    var concept_yScale = d3.scale.linear()
    .range([height, 0])
    .domain([0, (concept_yMax)]);

    var concept_xAxis = d3.svg.axis()
    .orient("bottom")
    .scale(concept_xScale)
    .tickPadding(0);

    var concept_yAxis = d3.svg.axis()
    .orient("left")
    .scale(concept_yScale)
    .tickSize(-width)
    .tickPadding(4);

    var concept_xAxisGroup = conceptSVG.append("g")
    .attr("class", "xAxis")
    .attr("transform", "translate(0, " + (height) + ")")
    .call(concept_xAxis);

    var concept_yAxisGroup = conceptSVG.append("g")
    .attr("class", "yAxis")
    .call(concept_yAxis);

    d3.select(".button-container").selectAll(".date-buttons")
    .data(topconcepts_list)
    .enter().append("button")
    .attr("class", "date-buttons")
    .text(function(d,i) {return 2013 + i;})
    .on("click", function(d) {
      title(this);
      drawRects(d);
      // console.log("d", d);
    });

    var tip = d3.tip()
      .attr("class", "tooltip")
      .offset([-20,0])
      .html(function(d,i) {
      return 'Click to see <br>' + d.values.length + ' pictures of <br>"' + d.key + '"';
      });

    drawRects(topconcepts_list[0]);


  var dataByDate = d3.nest()
    .key(function(d) {return d.date})
    .entries(data);

  var colorData = [];

  dataByDate.forEach(function(d,i){
    var holder = {};
    var currentDate = new Date(String(d.key.slice(0,7)) + "-01 00:00:00");
    var currentColors = d.values[0].color_predictions;
    var topCurrentColors = currentColors
    .sort(function(a,b){return b.value - a.value;})
    .filter(function(d,i){
      if(d.w3c.name !== "White"){
        return d;
      }
    })
    .filter(function(d,i){return i < 2;})

    topCurrentColors.forEach(function(d){
      d["date"] = currentDate;
    })
    holder["date"] = currentDate;
    holder["colors"] =  topCurrentColors;
    colorData.push(holder);
    });
console.log(colorData)

  nestedColorData = d3.nest()
  .key(function (d) {return d.date;})
  .entries(colorData);

  nestedColorData.forEach(function(d){
    d.key = new Date(d.key)

  })

  // console.log(nestedColorData);

  // colorData.forEach(function(d){
  //   var dateTime = new Date(d.date);
  //   d.date = dateTime;
  // })

  var color_xMin = d3.min(nestedColorData,function(d){return d.key;});
  var color_xMax = d3.max(nestedColorData,function(d){return d.key;});

  // console.log(color_xMax)
  // console.log(color_xMin)

  var color_xScale = d3.time.scale()
    .range([0,width])
    .domain([color_xMin, color_xMax]);

  // var concept_yScale = d3.scale.linear()
  // .range([height, 0])
  // .domain([0, (concept_yMax)]);
  //

  var color_xAxis = d3.svg.axis()
    .scale(color_xScale)
    .orient("bottom")
    .tickPadding(10)
    .tickFormat(d3.time.format("%b %Y"));


  var color_xAxisGroup = colorSVG.append("g")
  .attr("class", "xAxis")
  .attr("transform", "translate(0, " + (colorChartHeight) + ")")
  .call(color_xAxis);

  // var concept_yAxisGroup = conceptSVG.append("g")
  // .attr("class", "yAxis")
  // .call(concept_yAxis);
  var colorBlockContainer = colorSVG.selectAll(".colorBlocks")
    .data(nestedColorData)
    .enter()
    .append("g")
  .selectAll(".blocks")
    .data(function(d){
      // console.log([].concat.apply([],d.values.map(function(x){return x.colors})));

      // d.values = [ {} , {} , {}  ]
      // d.values.map(function(x) { return x.colors }) = [ {}.colors, {}.colors, {}.colors ]
      //                                               = [ [a,b], [c,d], [e,f] ]

      return [].concat.apply([],d.values.map(function(x){return x.colors}))  ;})
    .enter()
  //   .append("g")
  // .selectAll(".colors")
    // .data(function(d){return d.colors;})
    // .enter()
    .append("rect")
    .style("fill", function(d){
      // for(var i=0; i < 2; i++)
        return d.raw_hex;
    })
    .attr("transform", function(d,i){
        return "translate(" + (color_xScale(d.date) - 13) + "," + (colorChartHeight - (i*26) - 26) + ")";
      })

    .attr("width", "26px")
    .attr("height", "26px")





  function title(d) {
    var x = d.textContent;
    var title = d3.select("#concept-title")
    .html(function() {return "Top 20 Concepts Instagrammed in " + "<span style='text-decoration:underline'>" + x +"</span>";});
  }


  function drawRects(d) {
    // console.log("d", d);
    //  yMin = d3.min(d,function(d,i){return d.values.length;});
    //  yMax = d3.max(d,function(d,i){return d.values.length;});

    concept_xScale.domain(d.map(function(d){return d.key;}));
    //  yScale.domain([0, (yMax + 10)]);

    conceptSVG.select(".xAxis")
    // .duration(750)
    .call(concept_xAxis);
    // conceptSVG.select(".yAxis")
    //   // .duration(750)
    //   .call(yAxis);

    var rectsDataSel = conceptSVG.selectAll(".bar")
    .data(d)
    var rectsEnter = rectsDataSel
    .enter().append("rect")
    .attr("class", "bar");
    conceptSVG.selectAll(".bar")
    .style("fill", "#d3d3d3")
    .attr("x", function(d) { return concept_xScale(d.key); })
    .attr("width", concept_xScale.rangeBand())
    .attr("y", function(d) { return concept_yScale(d.values.length); })
    .attr("height", function(d) { return height - concept_yScale(d.values.length); })
    .attr("id", function(d) {
      $(this).click(function(){
        populatePhotoDiv(d.values);
        // console.log(d.values);
        // console.log(d.key);
      })
      return d.key;
    });


    conceptSVG.selectAll("rect")
    .call(tip)

    .on("mouseover", function(d) {
      tip.show(d);
    })

    .on("mouseout", function(d) {
      tip.hide(d);
    })

    rectsDataSel
    .exit().remove();
  }



  function populatePhotoDiv(d){
    // console.log("d",d);
    $('.photoDiv').html(" ");
    var length = d.length;

    for(var i = 0; i < length; i++){
      // console.log("photoindex",i);
      $('.photoDiv').append("<img src='" + d[i].url + "' width='10%' height='10%'>");
    }
  }
}

</script>
</body>
